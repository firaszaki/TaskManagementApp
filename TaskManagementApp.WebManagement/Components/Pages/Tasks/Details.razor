@page "/tasks/{Id:long}/details"

<MudContainer MaxWidth="MaxWidth.Small" Class="pt-2 fade-in">
    <PageHeader Title="Tasks" Description="Details of the task that has been registered." ReturnUrl="/" />

    <MudGrid>

        @if(Data is null)
        {
            <MudItem xs="12">
                <TaskManagementApp.WebManagement.Components.Shared.LoadingComponent />
            </MudItem>
            
        }
        else
        {
            <MudItem xs="12">
                <MudStack Spacing="0" Row Justify="Justify.SpaceBetween">
                    <MudButton Class="px-5" Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="@(() => NavigationManager.NavigateTo($"/tasks/{Id}/update"))">

                        <MudIcon Icon="@Icons.Material.Outlined.Edit" Class="me-2" />
                        <MudText Typo="Typo.body1">Update</MudText>

                    </MudButton>

                    <MudButton OnClick="OnClickDeleteAsync"
                               Size="Size.Small"
                               Color="Color.Error"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Outlined.Delete">
                        <MudText Typo="Typo.body1">Delete</MudText>
                    </MudButton>
                </MudStack>
                
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="pa-5 rounded-border" Outlined>
                    <MudText Typo="Typo.body1" Class="mb-n2">Title</MudText>
                    <MudText Typo="Typo.h6" Class="fw-bold mb-2">@Data.Title</MudText>

                    <MudText Typo="Typo.body1" Class="mb-n2">Description</MudText>
                    <MudText Typo="Typo.body1" Class="mb-2 fw-bold">@Data.Description</MudText>

                    <MudText Typo="Typo.body1" Class="mb-n2">Status</MudText>
                    <MudText Typo="Typo.body1" Align="Align.Start" Class="mb-2">
                        @switch (Data.Status)
                        {
                            case Domain.Entities.TaskStatus.InProgress:
                                <MudChip T="string" Size="Size.Medium" Icon="@Icons.Material.Filled.HourglassBottom" Color="Color.Default">
                                    <MudText Typo="Typo.body1">In Progress</MudText>
                                </MudChip>
                                break;

                            case Domain.Entities.TaskStatus.Pending:
                                <MudChip T="string" Size="Size.Medium" Icon="@Icons.Material.Filled.PendingActions" Color="Color.Warning">
                                    <MudText Typo="Typo.body1">Pending</MudText>
                                </MudChip>
                                break;

                            case Domain.Entities.TaskStatus.Completed:
                                <MudChip T="string" Size="Size.Medium" Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success">
                                    <MudText Typo="Typo.body1">Completed</MudText>
                                </MudChip>
                                break;
                        }
                    </MudText>

                    <MudText Typo="Typo.body1" Class="mb-n1">Created Date</MudText>
                    <MudText Typo="Typo.body1" Class="mb-2 fw-bold" Style="white-space: pre-line; line-height:1.1;">@(Data.CreatedAt.HasValue ? Data.CreatedAt.Value.ToString("h:mm tt \n d MMMM yyyy") : "")</MudText>
                </MudPaper>
            </MudItem>
        }
        
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public long Id { get; set; }

    [Inject] private TaskRepository TaskRepository { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;

    private TaskEntity? Data { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        await LoadDataAsync(Id);
    }

    private async Task LoadDataAsync(long id)
    {
        var result = await TaskRepository.GetAsync(id); 
        if(!result.IsSuccess)
        {
            Data = null;
            Snackbar.Add("Data not found", Severity.Error);
            NavigationManager.NavigateTo("/tasks");
            return;
        }

        Data = result.Data;
    }

    private async Task OnClickDeleteAsync()
    {
        DialogOptions dialogOptions = new()
        {
            BackgroundClass = "blurred-backdrop",
            CloseButton = true,
            FullWidth = true,
            MaxWidth = MaxWidth.Small
        };

        DialogParameters<DialogDelete> parameters = new DialogParameters<DialogDelete>()
        {
            { p => p.Message , "Confirm to delete this task?" }
        };

        var dialog = await DialogService.ShowAsync<DialogDelete>("Delete Task", parameters, dialogOptions);
        var result = await dialog.Result;
        if (!result!.Canceled)
        {
            using var context = DbContextFactory.CreateDbContext();
            var entity = await context.Tasks.FindAsync(Id);
            if (entity == null)
            {
                Snackbar.Add("Task not found", Severity.Error);
                return;
            }
            context.Tasks.Remove(entity);
            await context.SaveChangesAsync();

            Snackbar.Add("Successfully deleted", Severity.Success);

            NavigationManager.NavigateTo("/tasks");
        }
    }
}
